#!/bin/bash
################################################################################
# Script Name: pull_sdk.sh
# Description: Pull SDK from git repository with safety checks
# Author: @MrJamesLZAZ
# Date: 2024-11-28
# Usage: ./pull_sdk.sh [-h|--help] [branch_name]
# Note: This script is generated from template with environment variables
################################################################################

set -e
trap 'echo "Error occurred. Exiting..."; exit 1' ERR


################################################################################
# Get default branch from remote repository
################################################################################
func_9_2_get_default_branch() {

    # local default_branch=$(git ls-remote --symref origin HEAD | awk '/^ref:/ {sub("refs/heads/", "", $2); print $2}')
    # if [ -z "$default_branch" ]; then
    #     echo "Warning: Could not determine default branch, falling back to 'main'" >&2
    #     echo "main"
    #     return 1
    # fi

    local default_branch="${SDK_GIT_DEFAULT_BRANCH}"

    echo "$default_branch"
}

######################################################################
# Setup environment variables
######################################################################
func_1_1_setup_env(){
    # Get default branch once at script start
    DEFAULT_BRANCH=$(func_9_2_get_default_branch)
}

################################################################################
# Print help message
################################################################################
func_1_2_print_help() {
    cat << EOF
Usage: $(basename "$0") [-h|--help] [branch_name]

Pull SDK changes from remote git repository.

Arguments:
    branch_name     Target branch name to pull (default: all remote branches)

Options:
    -h, --help     Show this help message

Examples:
    $(basename "$0")                     # Pull default remote branch
    $(basename "$0") develop             # Pull only develop branch(if exists)
    $(basename "$0") all                 # Pull all remote branches
EOF
    # $(basename "$0") feature/xyz         # Pull only feature branch

    return 0
}
################################################################################
# 1. Check and configure Git user information if needed
################################################################################
func_2_1_check_git_user() {
    echo "Checking Git user configuration..."

    # Check global git config first
    local git_name=$(git config --global user.name)
    local git_email=$(git config --global user.email)

    # If still not set, prompt user for input
    if [ -z "$git_name" ]; then
        echo "Git user name is not configured."
        read -p "Please enter your name: " input_name
        if [ -z "$input_name" ]; then
            echo "Error: Name cannot be empty"
            return 1
        fi
        git config --global user.name "$input_name"
        echo "Git user name set to: $input_name"
    fi

    if [ -z "$git_email" ]; then
        echo "Git user email is not configured."
        read -p "Please enter your email: " input_email
        if [ -z "$input_email" ] || ! echo "$input_email" | grep -qE '^[^@]+@[^@]+\.[^@]+$'; then
            echo "Error: Invalid email format"
            return 1
        fi
        git config --global user.email "$input_email"
        echo "Git user email set to: $input_email"
    fi

    return 0
}

################################################################################
# 2. Verify SSH access using verify_ssh_key.sh
################################################################################
func_2_2_verify_ssh_access() {
    echo "Verifying SSH access..."
    if ! /usr/local/bin/verify_ssh_key.sh; then
        echo "Error: SSH key verification failed"
        return 1
    fi
    return 0
}

################################################################################
# 3. Validate repository exists and has correct remote
################################################################################
func_2_3_validate_repository() {
    cd "${SDK_INSTALL_PATH}"

    # For fresh repository (only .git exists), remove and clone again
    if [ -d ".git" ] && [ $(ls -A | grep -v '^.git$' | wc -l) -eq 0 ]; then
        echo "Fresh repository detected, performing clean clone..."
        cd ..
        rm -rf "${SDK_INSTALL_PATH}"
        git clone "${SDK_GIT_REPO}" "${SDK_INSTALL_PATH}" || return 1
        cd "${SDK_INSTALL_PATH}"
        return 0
    fi

    # Normal validation for existing repository
    if [ ! -d ".git" ]; then
        echo "Error: Not a git repository. Please initialize first"
        return 1
    fi

    local current_remote=$(git remote get-url origin 2>/dev/null || echo "")
    if [ "$current_remote" != "${SDK_GIT_REPO}" ]; then
        echo "Error: Repository remote URL mismatch"
        echo "Current: $current_remote"
        echo "Expected: ${SDK_GIT_REPO}"
        return 1
    fi

    return 0
}

################################################################################
# 4. Pull latest changes from remote repository
################################################################################
func_2_4_pull_changes() {
    local target_branch="$1"
    echo "Fetching remote information..."
    git fetch origin || return 1

    if [ "$target_branch" = "all" ]; then
        # Pull all remote branches
        func_2_5_pull_all_branches
        return $?
    else
        # Pull specific branch
        func_2_6_pull_single_branch "$target_branch"
        return $?
    fi
}

################################################################################
# Helper function to pull all remote branches
################################################################################
func_2_5_pull_all_branches() {
    echo "Pulling all remote branches..."
    local error_occurred=false

    # Get list of remote branches
    local remote_branches=$(git ls-remote --heads origin | grep -oP "refs/heads/\K.*")

    # Pull each branch
    for branch in $remote_branches; do
        echo -e "\nProcessing branch: $branch"
        if ! func_2_6_pull_single_branch "$branch"; then
            echo "Warning: Failed to pull branch '$branch'"
            error_occurred=true
            continue
        fi
    done

    # Always return to default branch if it exists
    if echo "$remote_branches" | grep -q "^${DEFAULT_BRANCH}$"; then
        echo -e "\nReturning to default branch: ${DEFAULT_BRANCH}"
        git checkout "${DEFAULT_BRANCH}"
    fi

    [ "$error_occurred" = true ] && return 1
    return 0
}

################################################################################
# Helper function to pull a single branch
################################################################################
func_2_6_pull_single_branch() {
    local branch="$1"
    echo "Pulling branch: $branch"

    # Check if working directory is clean
    if git rev-parse --verify HEAD >/dev/null 2>&1; then
        if ! git diff --quiet HEAD 2>/dev/null; then
            echo "Error: Working directory is not clean"
            return 1
        fi
    fi

    # Check if branch exists remotely
    if ! git ls-remote --heads origin "$branch" | grep -q "$branch"; then
        echo "Error: Branch '$branch' doesn't exist in remote repository"
        return 1
    fi

    # Checkout and pull
    if git rev-parse --verify "origin/$branch" >/dev/null 2>&1; then
        git checkout -B "$branch" "origin/$branch"
    else
        echo "Error: Remote branch not found"
        return 1
    fi

    git pull origin "$branch" || return 1
    return 0
}



################################################################################
# Main function to orchestrate the SDK pulling process
################################################################################
main() {
    func_1_1_setup_env

    # Parse command line arguments
    local branch=""  # empty means pull all branches

    if [ "$#" -gt 1 ]; then
        # a. if we have more than 1 argument, then it's an error
        echo "Error: Too many arguments"
        return 1
    elif [ "$#" -eq 1 ]; then
        # b.if we have 1 argument, then it's a branch name
        # Check for help flag
        if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
            func_1_2_print_help
        fi

        # Parse branch name if provided
        if [[ ! "$1" =~ ^- ]]; then
            branch="$1"
        else
            echo "Error: Invalid branch name format, should not start with '-'"
            return 1
        fi
    elif [ "$#" -eq 0 ]; then
        # c. if we have no argument, then use the default branch from remote
        branch="${DEFAULT_BRANCH}"
    else
        # d. if we have invalid arguments, then it's an error
        echo "Error: Invalid arguments number: $#"
        return 1
    fi

    echo "=== Starting SDK Pull Process ==="
    [ -n "$branch" ] && echo "Target branch: $branch" || echo "Target: All remote branches"

    func_2_1_check_git_user || exit 1
    func_2_2_verify_ssh_access || exit 1
    func_2_3_validate_repository || exit 1
    func_2_4_pull_changes "$branch" || exit 1

    echo "=== SDK Pull Process Completed Successfully ==="
}


# Execute main function with all arguments
main "$@"