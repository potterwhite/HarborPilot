#!/bin/bash
################################################################################
# Script Name: push_sdk.sh
# Description: Push SDK changes to git repository with safety checks
# Author: @MrJamesLZAZ
# Date: 2024-11-28
# Usage: ./push_sdk.sh [-h|--help] [branch_name] [commit_message]
# Note: This script is generated from template with environment variables
################################################################################

set -e

################################################################################
# Print help message
################################################################################
print_help() {
    cat << EOF
Usage: $(basename "$0") [-h|--help] [branch_name] [commit_message]

Push local SDK changes to remote git repository.

Arguments:
    branch_name     Target branch name to push (default: main)
    commit_message  Commit message (optional, will prompt if not provided)

Options:
    -h, --help     Show this help message

Examples:
    $(basename "$0")                     # Push to main branch
    $(basename "$0") develop             # Push to develop branch
    $(basename "$0") feature/xyz "msg"   # Push to feature branch with message
EOF
    exit 0
}

################################################################################
# Main function to orchestrate the SDK pushing process
################################################################################
main() {
    # Parse command line arguments
    local branch="main"  # default branch
    local commit_message=""

    # Check for help flag
    if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
        print_help
    fi

    # Parse branch name if provided
    if [ -n "$1" ] && [[ ! "$1" =~ ^- ]]; then
        branch="$1"
        shift
    fi

    # Parse commit message if provided
    if [ -n "$1" ]; then
        commit_message="$1"
    fi

    echo "=== Starting SDK Push Process ==="
    echo "Target branch: $branch"

    1_check_environment_variables || exit 1
    1_5_verify_ssh_access || exit 1
    1_8_check_git_user || exit 1
    2_validate_repository || exit 1
    3_check_git_status || exit 1
    4_handle_changes "$branch" "$commit_message" || exit 1

    echo "=== SDK Push Process Completed Successfully ==="
}

################################################################################
# 1. Validate all required environment variables are set
# Returns:
#   0 if all variables are set, 1 otherwise
################################################################################
1_check_environment_variables() {
    local required_vars=("${SDK_INSTALL_PATH}" "${SDK_GIT_REPO}")

    for var in "${required_vars[@]}"; do
        if [ -z "${var}" ]; then
            echo "Error: Required environment variables are not set"
            echo "Please ensure SDK_INSTALL_PATH and SDK_GIT_REPO are defined"
            return 1
        fi
    done
    return 0
}

################################################################################
# 1.5. Verify SSH access using verify_ssh_key.sh
# Returns:
#   0 if SSH access is verified, 1 otherwise
################################################################################
1_5_verify_ssh_access() {
    echo "Verifying SSH access..."
    if ! /usr/local/bin/verify_ssh_key.sh; then
        echo "Error: SSH key verification failed"
        return 1
    fi
    return 0
}

################################################################################
# 2. Validate repository exists and has correct remote
# Returns:
#   0 if repository is valid, 1 otherwise
################################################################################
2_validate_repository() {
    cd "${SDK_INSTALL_PATH}"

    if [ ! -d ".git" ]; then
        echo "Error: Not a git repository. Please run pull_sdk.sh first"
        return 1
    fi

    local current_remote=$(git remote get-url origin 2>/dev/null || echo "")
    if [ "$current_remote" != "${SDK_GIT_REPO}" ]; then
        echo "Error: Repository remote URL mismatch"
        echo "Current: $current_remote"
        echo "Expected: ${SDK_GIT_REPO}"
        return 1
    fi

    return 0
}

################################################################################
# 3. Check git status and show changes to user
# Returns:
#   0 if changes exist and user confirms, 1 otherwise
################################################################################
3_check_git_status() {
    local has_changes=false

    # Check for uncommitted changes
    local uncommitted_changes=$(git status --porcelain)
    if [ -n "$uncommitted_changes" ]; then
        echo "Uncommitted changes found:"
        git status --short
        has_changes=true
    fi

    # Check for unpushed commits
    local unpushed_commits=$(git log @{u}..HEAD --oneline 2>/dev/null || git log HEAD --oneline)
    if [ -n "$unpushed_commits" ]; then
        echo -e "\nUnpushed commits found:"
        echo "$unpushed_commits"
        has_changes=true
    fi

    if [ "$has_changes" = false ]; then
        echo "No changes or commits to push"
        return 1
    fi

    read -p "Do you want to continue with these changes? (y/N) " answer
    if [[ ! "$answer" =~ ^[Yy]$ ]]; then
        echo "Operation cancelled by user"
        return 1
    fi

    return 0
}

################################################################################
# 4. Handle changes: commit and push
# Returns:
#   0 on success, 1 on failure
################################################################################
4_handle_changes() {
    local branch="$1"
    local commit_message="$2"

    # If no commit message provided, prompt for one
    if [ -z "$commit_message" ]; then
        read -p "Enter commit message: " commit_message
        if [ -z "$commit_message" ]; then
            commit_message="Update SDK $(date +%Y-%m-%d %H:%M:%S)"
        fi
    fi

    # Check if branch exists locally
    if ! git rev-parse --verify "$branch" >/dev/null 2>&1; then
        echo "Branch '$branch' doesn't exist locally."
        read -p "Do you want to create it? (y/N) " answer
        if [[ ! "$answer" =~ ^[Yy]$ ]]; then
            echo "Operation cancelled by user"
            return 1
        fi
        echo "Creating and switching to branch '$branch'..."
        git checkout -b "$branch"
    else
        echo "Switching to branch '$branch'..."
        git checkout "$branch"
    fi

    echo "Committing changes..."
    git add .
    git commit -m "$commit_message"

    echo "Pushing to remote repository..."
    if ! git push origin "$branch"; then
        echo "Error: Failed to push changes"
        echo "Tip: You might need to pull latest changes first"
        return 1
    fi

    return 0
}

################################################################################
# 1.8. Check and configure Git user information if needed
# Returns:
#   0 on success, 1 on failure
################################################################################
1_8_check_git_user() {
    echo "Checking Git user configuration..."

    # Check global git config first
    local git_name=$(git config --global user.name)
    local git_email=$(git config --global user.email)

    # If not set globally, check repository config
    if [ -z "$git_name" ] || [ -z "$git_email" ]; then
        cd "${SDK_INSTALL_PATH}"
        git_name=$(git config user.name)
        git_email=$(git config user.email)
    fi

    # If still not set, prompt user for input
    if [ -z "$git_name" ]; then
        echo "Git user name is not configured."
        read -p "Please enter your name: " input_name
        if [ -z "$input_name" ]; then
            echo "Error: Name cannot be empty"
            return 1
        fi
        git config --global user.name "$input_name"
        echo "Git user name set to: $input_name"
    fi

    if [ -z "$git_email" ]; then
        echo "Git user email is not configured."
        read -p "Please enter your email: " input_email
        if [ -z "$input_email" ] || ! echo "$input_email" | grep -qE '^[^@]+@[^@]+\.[^@]+$'; then
            echo "Error: Invalid email format"
            return 1
        fi
        git config --global user.email "$input_email"
        echo "Git user email set to: $input_email"
    fi

    return 0
}

# Execute main function with all arguments
main "$@"