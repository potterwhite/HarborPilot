# version: '3.8'  # Specify docker-compose file version

services:  # Define services section
  dev:  # Development environment service
    build:  # Build configuration
      context: .  # Build context is current directory
      dockerfile: docker/Dockerfile  # Path to Dockerfile
      args:
        # Variable passing chain:
        # 1. Variables are defined in .env file
        # 2. docker-compose.yml reads from .env and passes to Dockerfile via args
        # 3. Dockerfile receives them using ARG directive
        # 4. Finally set as ENV in Dockerfile for runtime usage
        SDK_INSTALL_DIR: ${SDK_INSTALL_DIR}  # Pass SDK installation directory to Dockerfile
        SDK_PKG_NAME: ${SDK_PKG_NAME}
        CONTAINER_VOLUME_ROOT: ${CONTAINER_VOLUME_ROOT}
    logging: #the logging configuration
      driver: "json-file" #the type of log file
      options: #the options of the log file
        max-size: "100m" #the size of the log file
        max-file: "3" #the number of log files
        compress: "true" #compress the log file
    image: ${PROJECT_NAME:-embedded-dev}:${TAG:-latest}  # Image name with fallback values
    container_name: ${PROJECT_NAME:-embedded-dev}  # Container name with fallback value
    volumes:  # Volume mappings
      - /tmp/.X11-unix:/tmp/.X11-unix:rw  # X11 socket for GUI
      - ~/.vscode:/root/.vscode  # VSCode configs (optional)
      # Project directory mappings
      - ./volumes/src:${CONTAINER_VOLUME_ROOT}/src:rw  # Source code directory with read-write access
      - ./volumes/build:${CONTAINER_VOLUME_ROOT}/build:rw  # Build directory with read-write access
      - ./volumes/configs:${CONTAINER_VOLUME_ROOT}/configs:ro  # Config directory with read-only access
      - ./volumes/sdk:${CONTAINER_VOLUME_ROOT}/sdk:ro  # SDK directory mapping
      # SSH configuration mapping (optional)
      - ${SSH_MOUNT:-/dev/null}:/root/.ssh:ro  # SSH key mapping with fallback to /dev/null
    environment:  # Environment variables
      - DISPLAY=${DISPLAY}  # X11 display for GUI applications
      - DEV_USER=baytto  # Current user name
      - DEV_UID=1000  # Current user ID
    env_file:  # Environment file configuration
      - .env  # Development environment variables file
    working_dir: /work  # Set working directory inside container
    networks:
      - diy_network  # Use custom network
    privileged: true  # Run container with elevated privileges
    devices:  # Device mappings
      - "/dev/ttyUSB0:/dev/ttyUSB0"  # Map USB serial port
      - "/dev/ttyACM0:/dev/ttyACM0"  # Map USB ACM device
    tty: true  # Allocate a pseudo-TTY

networks:  # Network configuration
  diy_network:  # Custom network name
    driver: bridge  # Use bridged driver for network configuration
